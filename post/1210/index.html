<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <meta property="og:title" content=" Uploading multiple attachments with carrierwave/mongoid/nested_form &middot;  湖间小筑" />
        <meta property="og:site_name" content="湖间小筑" />
        <meta property="og:url" content="http://hzmangel.github.io/post/1210/" />

        
            <meta property="og:type" content="article" />
            <meta property="og:article:published_time" content="2013-05-07T23:30:25Z" />

            
                <meta property="og:article:tag" content="Programming" />
            
                <meta property="og:article:tag" content="rails" />
            
        

        <title>
            湖间小筑
            
                | Uploading multiple attachments with carrierwave/mongoid/nested_form
            
        </title>

        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://hzmangel.github.io/css/screen.css" />

        <link rel="canonical" href="http://hzmangel.github.io/post/1210/" />
    </head>

    <body>
        <div class="container" id="site-wrapper">
            <header>
    <div class="row">
        <div class="col-md-6" id="site-title">
            <a href="http://hzmangel.github.io/" title="湖间小筑" rel="home"><h2>湖间小筑</h2></a>
        </div>

        <div class="col-md-6" id="site-description">
            <i class="text-right muted"><div id="site-description">蓝天，小湖，湖水中一方小筑</div></i>
        </div>
    </div>

    <img src="/img/banner.jpg" class="img-responsive">
</header>

            <nav role="navigation">

</nav>







<section>
    <article class="post">

    <header>
        <h2 class="post-title"><a href='http://hzmangel.github.io/post/1210/'> Uploading multiple attachments with carrierwave/mongoid/nested_form</a> </h2>
        <div class="post-meta">发表于2013-05-07 23:30:25 </div>
    </header>

    <section>
        <div class="post-summary">

<p>Recently I have met a requirement that need to upload multiple attachments to
a rails project. After some investigations, I choose <code>carrierwave</code> finally.
Also, I selected <code>nested_form</code> to manage uploading and deleting multiple
attachments.### Gemfile</p>

<p>First thing to use those gems is updating <code>Gemfile</code> in the project, so those
lines have been added to the file:</p>

<pre><code># Mongoid
gem &quot;mongoid&quot;

# File upload
gem 'carrierwave'
gem 'carrierwave-mongoid', :require =&gt; 'carrierwave/mongoid'
gem &quot;mini_magick&quot;

# Form for multi model
gem 'nested_form'
</code></pre>

<p>After the modification, remember to run <code>bundle update</code> to update/install the
gems and dependencies.</p>

<h3 id="model:b5edfa6373c50342486587e36ad49b10">Model</h3>

<p>The next step is creating the models. For simplicity, there are only two
models in the project. One model named <code>Foo</code>, which contains a title field and
a relationship field with the other model <code>FooImage</code>. Here is the definition
of model <code>Foo</code>.</p>

<pre><code>class Foo
  include Mongoid::Document

  field :title, type: String

  has_many :foo_images # Photoes of the dish
  accepts_nested_attributes_for :foo_images, :allow_destroy =&gt; true
end
</code></pre>

<p>The <code>accepts_nested_attributes_for</code> keyword enables saving associated records
though the parent, while the <code>:allow_destroy</code> parameter allows deleting
associated though attributes hash.</p>

<p>Here comes the <code>FooImage</code> model:</p>

<pre><code>class FooImage
  include Mongoid::Document

  attr_accessible :image
  mount_uploader :image, FooUploader

  belongs_to :foo
end
</code></pre>

<p>This model only contains one field <code>:image</code>, and the difference between others
is the <code>mount_uploader</code> keyword, which is used to mount given uploader to the
given column, then assigning and reading from this field will upload and
retrieve files. The <em>uploader</em> is introduced by <code>carrierwave</code>, which will be
introduced in next section.</p>

<h3 id="uploader:b5edfa6373c50342486587e36ad49b10">Uploader</h3>

<p>Uploader is used to handle the file uploaded to the server, which will save
the file to specified location with multiple version. A uploader can be
created by the command listed below:</p>

<pre><code>rails g uploader Foo
</code></pre>

<p>A new uploader <code>foo_uploader.rb</code> will be generated under directory
<code>app/uploaders/</code> after command return. The uploader generated by default can
handle file uploading, and you can add some other function, such as scaling
image, set whitelisted extension, in the uploader. Remember to remove the
comment character from either <code>CarrierWave::RMagick</code> or
<code>CarrierWave::MiniMagick</code> line to enable scaling function. <code>Carrierwave</code> alwo
support uploading file to cloud storage such as s3 directly, please refer to
the document for detail. In this uploader, I scale the uploaded image to
<code>800x600</code> and add a thumbnail version with size <code>80x60</code>, here is the code:</p>

<pre><code>process :resize_to_fill =&gt; [800, 600]

version :thumb do
  process :resize_to_fill =&gt; [80, 60]
end
</code></pre>

<p><strong>NOTICE</strong>: The generated uploader uses <code>scale</code> for resizing, remember to replace it with existing function like <code>resize_to_fill</code>.</p>

<h3 id="views:b5edfa6373c50342486587e36ad49b10">Views</h3>

<p>The last thing is the view. I plan to use two views in the project. Since this
is just a simple demo, I have only created one record and shown the title and
images with table.</p>

<p>By the way, if you want to deploy this application on production environment,
please make sure those two configuration:</p>

<ul>
<li><p>Make sure your web server, such as <code>Nginx</code>, <code>Apache</code>, has write permission to its temp path. If you don&rsquo;t know which directory is it, you can use this simple method to determine: First, check whether the production server can complete process of uploading attachment (Just uploading only, showing of image may have another problem which will be talked about below ). If there is no error, then the permission issue has already done. But if error occurred, please refer to the error log or access log of web server for tracing.</p></li>

<li><p>Now the second problem, showing the image. After uploading successfully, you may can&rsquo;t see the uploaded file. The problem is because production server do not serve static files. The quick fix for this is changing line <code>config.serve_static_assets = false</code> to <code>true</code>, but it is not the recommended way, since the production server can&rsquo;t server static file efficiently. The better method is configuring web server to serve those static file directly, please refer to web server&rsquo;s manual for detail.</p></li>
</ul>

<p>So, that&rsquo;s it. Thanks for reading, and here is the <a href="https://github.com/hzmangel/carrierwave-nestedform-mongoid">link of project on
GitHub</a>, any
comments are appreciated.</p>
</div>
    </section>

    <footer>
        <div class="post-meta">
            分类：
            <ul class="list-inline">
                 <li><a href="/categories/happy-coding">Happy coding</a></li> 
            </ul>
        </div>

        <div class="post-meta">
            标签：
            <ul class="list-inline">
                 <li><a href="/tags/programming"><span class="label label-default">Programming</span></a></li>  <li><a href="/tags/rails"><span class="label label-default">rails</span></a></li> 
            </ul>
        </div>

        <br/>
        <nav class="post-meta">
            <p class="col-md-6">
                 <a class="previous" href="http://hzmangel.github.io/post/1214/"> &lt; Some failed attempts on PNaCl </a> 
            </p>

            <p class="col-md-6">
                 <a class="next" href="http://hzmangel.github.io/post/1205/"> Using Rails with Redis &gt;</a> 
            </p>
        </nav>
        <br/>

    </footer>

</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'hzmangel';
    var disqus_identifier = 'http:\/\/hzmangel.github.io\/post\/1210\/';
    var disqus_title = 'Uploading multiple attachments with carrierwave\/mongoid\/nested_form';
    var disqus_url = 'http:\/\/hzmangel.github.io\/post\/1210\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</section>

<aside>
</aside>



        <footer class="site-footer clearfix">
            <div id="colophon">
                <section class="col-md-7">Copyright - ©2015 - hzmangel</section>
                
                    <i class="text-right"><section class="col-md-5">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/hzmangel/hugo-twenty-ten">ported Twenty Ten</a> theme</section></i>
                
            </div>
        </footer>

        <script src="http://code.jquery.com/jquery-git2.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="http://hzmangel.github.io/js/index.js"></script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-1847567-5', 'auto');
            ga('send', 'pageview');
        </script>

    </div> 

</body>
</html>



