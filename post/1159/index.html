<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <meta property="og:title" content=" Playing MongoDB with Rails &middot;  湖间小筑" />
        <meta property="og:site_name" content="湖间小筑" />
        <meta property="og:url" content="http://hzmangel.github.io/post/1159/" />

        
            <meta property="og:type" content="article" />
            <meta property="og:article:published_time" content="2012-06-19T16:07:16Z" />

            
                <meta property="og:article:tag" content="Programming" />
            
                <meta property="og:article:tag" content="rails" />
            
        

        <title>
            湖间小筑
            
                | Playing MongoDB with Rails
            
        </title>

        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://hzmangel.github.io/css/screen.css" />

        <link rel="canonical" href="http://hzmangel.github.io/post/1159/" />
    </head>

    <body>
        <div class="container" id="site-wrapper">
            <header>
    <div class="row">
        <div class="col-md-6" id="site-title">
            <a href="http://hzmangel.github.io/" title="湖间小筑" rel="home"><h2>湖间小筑</h2></a>
        </div>

        <div class="col-md-6" id="site-description">
            <i class="text-right muted"><div id="site-description">蓝天，小湖，湖水中一方小筑</div></i>
        </div>
    </div>

    <img src="/img/banner.jpg" class="img-responsive">
</header>

            <nav role="navigation">

</nav>







<section>
    <article class="post">

    <header>
        <h2 class="post-title"><a href='http://hzmangel.github.io/post/1159/'> Playing MongoDB with Rails</a> </h2>
        <div class="post-meta">发表于2012-06-19 16:07:16 </div>
    </header>

    <section>
        <div class="post-summary">

<p>This post will try to implement a web app used for recording mobile phone of
cheaters. This idea is came from cooler@linuxfb, and I have used this for a
presentation about GAE on 2009, and here is the
<a href="http://www.slideshare.net/linuxfb/20090222-gae-demo-7083477">slide</a>.</p>

<p>NOTE: Code still under developing, the Git repo is shown at the end of
article.Creating Rails project has been talked in previous post, so this post will
focus on others.</p>

<h2 id="mongodb:9c891c3667928d9a98ce25e09d55dbc7">MongoDB</h2>

<p>Thought I have heard MongoDB before, I just start to use it recently. It is a
document based NoSQL database, and it is developer friendly. Detailed
information can be get from its <a href="http://www.mongodb.org/">website</a>.</p>

<ol>
<li>Install MongoDB on MacOS</li>
</ol>

<p>On MacOS, the MongoDB can be installed via
<a href="http://mxcl.github.com/homebrew/">homebrew</a></p>

<p>brew install mongodb</p>

<p>The MongoDB will be installed if no error occurred. Now we should configure
the MongoDB started up while system starts up.</p>

<ol>
<li>Install driver</li>
</ol>

<p>For using MongoDB with Ruby, the gem <code>mongo</code> and <code>bson_ext</code> is needed, the
second gem is used to improve performance. The gem <code>mongo</code> is the driver for
MongoDB while <code>bson_ext</code> is used to improve performance.</p>

<p>gem install mongo gem install bson_ext</p>

<ol>
<li>Install Mongoid gem</li>
</ol>

<p>This gem can be used to provide object mapper to the Rails, which can provide
more useful features such as <strong>validations</strong>, <strong>associations</strong> and other high-
level data modeling functions. Like other gems, you can install <code>Mongoid</code> via
gem easily.</p>

<p>gem install mongoid</p>

<p>Besides Mongoid, there are also some other mappers, which can be linked from
the doucment page of MongoDB.</p>

<p>After those steps done, the system is ready for playing MongoDB with Rails,
let&rsquo;s go.</p>

<h2 id="web-app:9c891c3667928d9a98ce25e09d55dbc7">Web App</h2>

<h3 id="prepare-the-rails-gem:9c891c3667928d9a98ce25e09d55dbc7">Prepare the Rails Gem</h3>

<p>After creating the Rails application with <code>--skip-active-record</code> option, the
<code>Gemfile</code> should also be updated to include MongoDB related gems. Here is the
new added lines in the <code>Gemfile</code>.</p>

<pre><code>gem 'mongo'
gem 'bson_ext'
gem &quot;mongoid&quot;, &quot;~&gt; 3.0.0.rc&quot;
</code></pre>

<p>After adding those lines into <code>Gemfile</code>, remember to run <code>bundle install</code> for
checking the dependencies.</p>

<h3 id="generate-configuration-file-for-mongoid:9c891c3667928d9a98ce25e09d55dbc7">Generate Configuration File for <code>mongoid</code></h3>

<p>The configuration file of <code>mongoid</code> can be generated with command <code>rails g
mongoid:config</code>, then the file <code>config/mongoid.yml</code> will be generated. The
generated file has some options and plenty of comments, so it is easy to
modify it as requirements.</p>

<h3 id="the-web-app:9c891c3667928d9a98ce25e09d55dbc7">The Web App</h3>

<h4 id="the-model:9c891c3667928d9a98ce25e09d55dbc7">The Model</h4>

<p>For fast developing, we are using <code>scaffold</code> here. This web app should save
two type of data, one is cheater and the other is provider. The <code>Cheaters</code>
collection will save the information about cheaters, which contains the mobile
phone number to identify, the description , and how many votes have been
applied to this record. The <code>Providers</code> collection will save E-mail address of
provider and how many mobile phones have been submitted. Here is the command:</p>

<pre><code>rails g scaffold cheater mobile:string desc:string vote_up:integer vote_down:integer -T -O
rails g scaffold provider email:string -T -O
</code></pre>

<p>The generator will generate the model with <code>mongoid</code> module, instead of
<code>ActiveRecord</code> module. The <code>Cheaters</code> and <code>Providers</code> should have <strong>many-to-
many</strong> relationship, which is specified by keyword <code>has_and_belongs_to_many</code>,
so the generated model file should be updated to this:</p>

<pre><code>class Cheater
  include Mongoid::Document
  field :mobile, type: String
  field :desc, type: String
  field :vote_up, type: Integer
  field :vote_down, type: Integer

  has_and_belongs_to_many :providers
end


class Provider
  include Mongoid::Document
  field :email, type: String

  has_and_belongs_to_many :cheaters
end
</code></pre>

<p>Do not like the SQL database, there is no migration needed for MongoDB, which
is more convenient during the development and upgrade.</p>

<h4 id="the-controller-and-viewers:9c891c3667928d9a98ce25e09d55dbc7">The Controller and Viewers</h4>

<p>The scaffold generated contains controllers, views and URL mapping, now we are
going to go though the controller. The file <code>config/routers.rb</code> dispatch the
URL mapping to the model controller by using <code>resources</code> keyword, and the
server will response to URL <code>/providers</code> and <code>/cheaters</code>. The generated view
can perform basic operations to the data. The prime tasks here is complete the
basic operations of data and create a index page about this application.</p>

<p>I plan to use the controller generated as scaffold only sending and receiving
JSON data, so a new controller named <code>smedia</code> (means static media, I prefer
this name for this) will be created.</p>

<pre><code>rails g controller smedia -T -O
</code></pre>

<p>The root path will be set to the smedia page after the controller generated.
Remember to remove the <code>public/index.html</code> before enabling the root routings.</p>

<p>In the index page, there will be two blocks. One block is used to display the
cheaters ordered by top positive vote, and the other block is used for
submitting new cheater information. Gem <a href="https://github.com/seyhunak/twitter-bootstrap-rails"><code>twitter-bootstrap-
rails</code></a> will be used to
beautify the web page. As mentioned in the document page, those two commands
can be used to initialize the bootstrap framework:</p>

<pre><code>rails g bootstrap:install
rails g bootstrap:layout application fixed
</code></pre>

<p>The first line will prepare the bootstrap assets, and the second is creating
layout with bootstrap template. Please follow the <a href="https://github.com/seyhunak/twitter-bootstrap-rails">document
page</a> for more detail.</p>

<p>The web page will show the cheater&rsquo;s list by default, and there is a form to
submit the cheater information. The <code>vote</code> field in <code>Cheaters</code> collection is
used to record how many agreement or disagreement to this possible cheater.
The detail implementation can be referred from the source code:
<a href="https://github.com/hzmangel/cheater-recorder">https://github.com/hzmangel/cheater-recorder</a></p>
</div>
    </section>

    <footer>
        <div class="post-meta">
            分类：
            <ul class="list-inline">
                 <li><a href="/categories/happy-coding">Happy coding</a></li> 
            </ul>
        </div>

        <div class="post-meta">
            标签：
            <ul class="list-inline">
                 <li><a href="/tags/programming"><span class="label label-default">Programming</span></a></li>  <li><a href="/tags/rails"><span class="label label-default">rails</span></a></li> 
            </ul>
        </div>

        <br/>
        <nav class="post-meta">
            <p class="col-md-6">
                 <a class="previous" href="http://hzmangel.github.io/post/1166/"> &lt; Dismiss keyboard in UITextViewController </a> 
            </p>

            <p class="col-md-6">
                 <a class="next" href="http://hzmangel.github.io/post/1147/"> Tunning Rails with DTrace &gt;</a> 
            </p>
        </nav>
        <br/>

    </footer>

</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
     
    var disqus_shortname = "hzmangel";

     
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


</section>

<aside>
</aside>



        <footer class="site-footer clearfix">
            <div id="colophon">
                <section class="col-md-7">Copyright - ©2015 - hzmangel</section>
                
                    <i class="text-right"><section class="col-md-5">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/hzmangel/hugo-twenty-ten">ported Twenty Ten</a> theme</section></i>
                
            </div>
        </footer>

        <script src="http://code.jquery.com/jquery-git2.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="http://hzmangel.github.io/js/index.js"></script>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-1847567-5', 'auto');
            ga('send', 'pageview');
        </script>

    </div> 

</body>
</html>



